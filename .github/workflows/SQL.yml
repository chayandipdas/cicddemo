name: SQL Database Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  sql-deploy:
    runs-on: windows-latest
    environment: production   # ðŸ‘ˆ use environment secrets for DB credentials

    env:
      DB_SERVER: "115.124.106.157"
      DB_NAME: "dharasuta_2026_CICD"
      DB_USER: "dharasuta_2026_CICD"
      DB_PASSWORD: "CDAdmin@123"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Install sqlcmd (for SQL Server) or psql (for PostgreSQL)
      - name: Install SQL Server Command Line Tools
        run: |
          choco install mssql-tools -y
          echo '##[add-path]C:\Program Files\Microsoft SQL Server\Client SDK\ODBC\170\Tools\Binn'
        shell: powershell

      - name: Run SQL scripts
        run: |
          for file in ./sql-scripts/*.sql; do
            echo "Running $file..."
            sqlcmd -S $DB_SERVER -d $DB_NAME -U $DB_USER -P $DB_PASSWORD -i $file
          done
