name: SQL Database Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  sql-deploy:
    runs-on: ubuntu-latest
    environment: production   # ðŸ‘ˆ use environment secrets for DB credentials

    env:
      DB_SERVER: "115.124.106.157"
      DB_NAME: "dharasuta_2026_CICD"
      DB_USER: "dharasuta_2026_CICD"
      DB_PASSWORD: "CDAdmin@123"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

       # â”€â”€ 3. Install sqlcmd (Microsoft SQL Server tools) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install sqlcmd
        run: |
          curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
          curl https://packages.microsoft.com/config/ubuntu/22.04/prod.list \
            | sudo tee /etc/apt/sources.list.d/msprod.list
          sudo apt-get update -y
          sudo ACCEPT_EULA=Y apt-get install -y mssql-tools18 unixodbc-dev
          echo "/opt/mssql-tools18/bin" >> $GITHUB_PATH


      # â”€â”€ 4. Verify SQL server connectivity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Test Database Connection
        run: |
          echo "Testing connection to $DB_SERVER / $DB_NAME ..."
          sqlcmd \
            -S "$DB_SERVER" \
            -d "$DB_NAME" \
            -U "$DB_USER" \
            -P "$DB_PASSWORD" \
            -C \
            -No \
            -Q "SELECT @@VERSION AS [SQL Server Version], DB_NAME() AS [Database];"
          echo "âœ… Connection successful."

          
      - name: Run SQL scripts
        run: |
          for file in ./sql-scripts/*.sql; do
            echo "Running $file..."
            sqlcmd -S $DB_SERVER -d $DB_NAME -U $DB_USER -P $DB_PASSWORD -No -i $file
          done
