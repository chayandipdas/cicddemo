name: CD Build and Deploy .NET App

on:
  workflow_dispatch: 
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    # Inject environment variables and secrets
    env:
      DOTNET_ENVIRONMENT: Production
      DB_CONNECTION_STRING: ${{ secrets.DB_CONNECTION_STRING }}
      API_KEY: ${{ secrets.API_KEY }}
      CD_KEY: "dddd"

    steps:
      # Step 1: Checkout code
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Setup .NET
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      # Step 3: Restore dependencies
      - name: Restore dependencies
        run: dotnet restore

      # Step 4: Build project
      - name: Build project
        run: dotnet build --configuration Release --no-restore

      # Step 5: Run tests
      - name: Run tests
        run: dotnet test --no-build --verbosity normal

      # Step 6a: (Optional) Replace tokens in appsettings.json
      # Only needed if you want secrets inside appsettings.json
      - name: Replace tokens in appsettings.json
        run: |
          sed -i "s|#{DB_CONNECTION_STRING}#|${DB_CONNECTION_STRING}|g" appsettings.json
          sed -i "s|#{API_KEY}#|${API_KEY}|g" appsettings.json
          sed -i "s|#{CD_KEY}#|${CD_KEY}|g" appsettings.json


      # Step 6: Publish app
      - name: Publish app
        run: dotnet publish -c Release -o ./publish
  
      # âœ… New step: Upload publish folder as artifact
      - name: Upload publish artifact
        uses: actions/upload-artifact@v4
        with:
          name: dotnet-publish
          path: ./publish
